<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zee's Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    :root {
      --bg: #0a1f2e;
      --panel: #0f2d3d;
      --accent: #00d4d4;
      --accent-2: #ff6ec7;
      --accent-3: #7fffb0;
      --text: #e8f4f8;
      --muted: #a0c4d4;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #051a24, var(--bg));
      color: var(--text);
      min-height: 100vh;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      max-width: 1100px;
      margin: auto;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2), var(--accent-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    main {
      padding: 0 24px 64px;
      max-width: 1100px;
      margin: auto;
      display: grid;
      gap: 18px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .requests {
      display: grid;
      gap: 14px;
    }

    .request {
      background: linear-gradient(135deg, rgba(0, 212, 212, 0.08), rgba(127, 255, 176, 0.08));
      border-radius: 14px;
      padding: 14px;
      border: 1px solid rgba(0, 212, 212, 0.2);
      display: grid;
      gap: 10px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
    }

    .request:hover {
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 30px 60px rgba(0, 212, 212, 0.25);
      border-color: var(--accent-2);
    }

    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .request-meta {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status.pending {
      background: rgba(255, 230, 120, 0.18);
      color: #ffe678;
    }

    .status.completed {
      background: rgba(0, 212, 212, 0.2);
      color: var(--accent);
    }

    .request-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card {
      background: linear-gradient(135deg, rgba(0, 212, 212, 0.08), rgba(127, 255, 176, 0.08));
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(0, 212, 212, 0.2);
      transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
    }

    .card:hover {
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 30px 60px rgba(0, 212, 212, 0.25);
      border-color: var(--accent-2);
    }

    .reveal {
      opacity: 0;
      transform: translateY(16px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .reveal.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .card h3 {
      margin-top: 0;
      background: linear-gradient(135deg, var(--accent), var(--accent-3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .card p {
      margin: 8px 0;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
    }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      background: rgba(0, 212, 212, 0.15);
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-3));
      color: #000;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      box-shadow: 0 15px 40px rgba(0, 212, 212, 0.3);
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 50px rgba(0, 212, 212, 0.5);
    }

    .btn.secondary {
      background: transparent;
      color: var(--text);
      border: 2px solid var(--accent-2);
      box-shadow: none;
    }

    .btn.secondary:hover {
      background: rgba(255, 110, 199, 0.1);
    }

    .btn.danger {
      background: rgba(255, 99, 99, 0.2);
      color: #ffd1d1;
      border: 2px solid rgba(255, 99, 99, 0.35);
      box-shadow: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>Zee's Admin Dashboard</h1>
    <button id="logoutBtn" class="btn secondary" type="button">Logout</button>
  </header>

  <main>
    <div class="pill">Signed in</div>
    <div class="card">
      <h3>Welcome back</h3>
      <p>Signed in as: <span id="userEmail">Loading...</span></p>
      <p>This dashboard is protected by Supabase Auth. Only invited admins can access it.</p>
    </div>

    <div class="card">
      <h3>Repair requests</h3>
      <p id="requestsMeta">Loading requests...</p>
      <div id="requests" class="requests"></div>
    </div>

    <div class="card">
      <h3>Reviews</h3>
      <p id="reviewsMeta">Loading reviews...</p>
      <div id="reviews" class="requests"></div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const emailEl = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const requestsEl = document.getElementById('requests');
    const requestsMeta = document.getElementById('requestsMeta');
    const reviewsEl = document.getElementById('reviews');
    const reviewsMeta = document.getElementById('reviewsMeta');

    const revealObserver = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (!entry.isIntersecting) {
          return;
        }
        entry.target.classList.add('is-visible');
        revealObserver.unobserve(entry.target);
      });
    }, { threshold: 0.2 });

    const applyRevealTargets = () => {
      document.querySelectorAll('header, .card, .request').forEach((el) => {
        if (!el.classList.contains('reveal')) {
          el.classList.add('reveal');
        }
        revealObserver.observe(el);
      });
    };

    function formatDate(value) {
      if (!value) {
        return "Unknown time";
      }
      return new Date(value).toLocaleString();
    }

    function renderRequests(requests) {
      requestsEl.innerHTML = "";

      if (!requests.length) {
        requestsMeta.textContent = "No requests yet.";
        return;
      }

      requestsMeta.textContent = `${requests.length} request(s) total.`;

      requests.forEach((request) => {
        const card = document.createElement('div');
        card.className = 'request';

        const header = document.createElement('div');
        header.className = 'request-header';

        const title = document.createElement('strong');
        title.textContent = request.name || 'No name';

        const status = document.createElement('span');
        const statusValue = (request.status || 'Pending').toLowerCase();
        status.className = `status ${statusValue === 'completed' ? 'completed' : 'pending'}`;
        status.textContent = request.status || 'Pending';

        header.appendChild(title);
        header.appendChild(status);

        const meta = document.createElement('div');
        meta.className = 'request-meta';

        const addMetaLine = (label, value) => {
          const line = document.createElement('span');
          const strong = document.createElement('strong');
          strong.textContent = `${label}:`;
          line.appendChild(strong);
          line.append(` ${value || 'N/A'}`);
          meta.appendChild(line);
        };

        addMetaLine('Email', request.email);
        addMetaLine('Phone', request.phone);
        addMetaLine('Device', request.device);
        addMetaLine('Issue', request.issue);
        addMetaLine('Created', formatDate(request.created_at));

        const actions = document.createElement('div');
        actions.className = 'request-actions';

        const completeBtn = document.createElement('button');
        completeBtn.className = 'btn secondary';
        completeBtn.textContent = 'Mark completed';
        completeBtn.dataset.action = 'complete';
        completeBtn.dataset.id = request.id;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn danger';
        deleteBtn.textContent = 'Delete';
        deleteBtn.dataset.action = 'delete';
        deleteBtn.dataset.id = request.id;

        actions.appendChild(completeBtn);
        actions.appendChild(deleteBtn);

        card.appendChild(header);
        card.appendChild(meta);
        card.appendChild(actions);
        requestsEl.appendChild(card);
      });
      applyRevealTargets();
    }

    function renderReviews(reviews) {
      reviewsEl.innerHTML = "";

      if (!reviews.length) {
        reviewsMeta.textContent = "No reviews yet.";
        return;
      }

      reviewsMeta.textContent = `${reviews.length} review(s) total.`;

      reviews.forEach((review) => {
        const card = document.createElement('div');
        card.className = 'request';

        const header = document.createElement('div');
        header.className = 'request-header';

        const title = document.createElement('strong');
        title.textContent = review.name || 'Anonymous';

        const status = document.createElement('span');
        const statusValue = (review.status || 'Pending').toLowerCase();
        status.className = `status ${statusValue === 'approved' ? 'completed' : 'pending'}`;
        status.textContent = review.status || 'Pending';

        header.appendChild(title);
        header.appendChild(status);

        const meta = document.createElement('div');
        meta.className = 'request-meta';

        const addLine = (label, value) => {
          const line = document.createElement('span');
          const strong = document.createElement('strong');
          strong.textContent = `${label}:`;
          line.appendChild(strong);
          line.append(` ${value || 'N/A'}`);
          meta.appendChild(line);
        };

        addLine('Device', review.device);
        addLine('Problem', review.problem);
        addLine('Rating', `${review.rating || 0} / 5`);
        addLine('Share', review.share_permission || 'No');
        addLine('Review', review.text);
        addLine('Created', formatDate(review.created_at));

        const actions = document.createElement('div');
        actions.className = 'request-actions';

        const approveBtn = document.createElement('button');
        approveBtn.className = 'btn secondary';
        approveBtn.textContent = 'Approve';
        approveBtn.dataset.action = 'approve';
        approveBtn.dataset.id = review.id;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn danger';
        deleteBtn.textContent = 'Delete';
        deleteBtn.dataset.action = 'delete';
        deleteBtn.dataset.id = review.id;

        actions.appendChild(approveBtn);
        actions.appendChild(deleteBtn);

        card.appendChild(header);
        card.appendChild(meta);
        card.appendChild(actions);
        reviewsEl.appendChild(card);
      });
      applyRevealTargets();
    }

    const supabaseUrl = "https://vdtqfwnlhqokpedojjlw.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkdHFmd25saHFva3BlZG9qamx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNzI5OTEsImV4cCI6MjA4MTYzMjk5MX0.PnL3DZtt6LhnXxsExeGm20brR-4NEgh_ti5Pvkb6Ijc";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    async function loadRequests() {
      requestsMeta.textContent = "Loading requests...";
      const { data, error } = await supabaseClient
        .from('requests')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        requestsMeta.textContent = "Failed to load requests.";
        return;
      }

      renderRequests(data || []);
    }

    async function loadReviews() {
      reviewsMeta.textContent = "Loading reviews...";
      const { data, error } = await supabaseClient
        .from('reviews')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        reviewsMeta.textContent = "Failed to load reviews.";
        return;
      }

      renderReviews(data || []);
    }

    async function updateStatus(id, status) {
      const { error } = await supabaseClient
        .from('requests')
        .update({ status })
        .eq('id', id);

      if (error) {
        alert("Failed to update status.");
        console.error(error);
        return;
      }

      loadRequests();
    }

    async function deleteRequest(id) {
      const { error } = await supabaseClient
        .from('requests')
        .delete()
        .eq('id', id);

      if (error) {
        alert("Failed to delete request.");
        console.error(error);
        return;
      }

      loadRequests();
    }

    async function approveReview(id) {
      const { error } = await supabaseClient
        .from('reviews')
        .update({ status: 'Approved' })
        .eq('id', id);

      if (error) {
        alert("Failed to approve review.");
        console.error(error);
        return;
      }

      loadReviews();
    }

    async function deleteReview(id) {
      const { error } = await supabaseClient
        .from('reviews')
        .delete()
        .eq('id', id);

      if (error) {
        alert("Failed to delete review.");
        console.error(error);
        return;
      }

      loadReviews();
    }

    supabaseClient.auth.getUser().then(({ data }) => {
      if (!data || !data.user) {
        window.location.href = "/login";
        return;
      }
      emailEl.textContent = data.user.email || "Signed in";
      loadRequests();
      loadReviews();
    });

    logoutBtn.addEventListener('click', async () => {
      await supabaseClient.auth.signOut();
      window.location.href = "/login";
    });

    requestsEl.addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) {
        return;
      }
      const id = button.dataset.id;
      if (!id) {
        return;
      }

      if (button.dataset.action === 'complete') {
        updateStatus(id, 'Completed');
      } else if (button.dataset.action === 'delete') {
        if (confirm('Delete this request?')) {
          deleteRequest(id);
        }
      }
    });

    reviewsEl.addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) {
        return;
      }
      const id = button.dataset.id;
      if (!id) {
        return;
      }

      if (button.dataset.action === 'approve') {
        approveReview(id);
      } else if (button.dataset.action === 'delete') {
        if (confirm('Delete this review?')) {
          deleteReview(id);
        }
      }
    });

    applyRevealTargets();
  </script>
<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "1c5ec302dc85429dae72a3c93e17b566"}'></script><!-- End Cloudflare Web Analytics -->
</body>
</html>

