<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zee's Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #0b0f14;
      color: #fff;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(90deg, #2fffdc, #ff7ac6);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #000;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
    }

    main {
      padding: 20px;
      max-width: 1100px;
      margin: auto;
      display: grid;
      gap: 18px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .requests {
      display: grid;
      gap: 14px;
    }

    .request {
      background: #111720;
      border-radius: 12px;
      padding: 14px;
      border: 1px solid rgba(47, 255, 220, 0.12);
      display: grid;
      gap: 10px;
    }

    .request-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .request-meta {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: #cfd9e2;
    }

    .status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .status.pending {
      background: rgba(255, 230, 120, 0.18);
      color: #ffe678;
    }

    .status.completed {
      background: rgba(47, 255, 220, 0.18);
      color: #2fffdc;
    }

    .request-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card {
      background: #141a22;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 0 20px rgba(47, 255, 220, 0.1);
      border: 1px solid rgba(47, 255, 220, 0.08);
    }

    .card h3 {
      margin-top: 0;
      color: #2fffdc;
    }

    .card p {
      margin: 8px 0;
      font-size: 14px;
      color: #cfd9e2;
      line-height: 1.5;
    }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      background: rgba(47, 255, 220, 0.15);
      color: #2fffdc;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    button {
      background: #2fffdc;
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      opacity: 0.85;
    }

    button.secondary {
      background: #1d2936;
      color: #cfd9e2;
      border: 1px solid rgba(207, 217, 226, 0.2);
    }

    button.danger {
      background: #ff7ac6;
    }
  </style>
</head>
<body>
  <header>
    <h1>Zee's Admin Dashboard</h1>
    <button id="logoutBtn" type="button">Logout</button>
  </header>

  <main>
    <div class="pill">Signed in</div>
    <div class="card">
      <h3>Welcome back</h3>
      <p>Signed in as: <span id="userEmail">Loading...</span></p>
      <p>This dashboard is protected by Netlify Identity. Only invited admins can access it.</p>
    </div>

    <div class="card">
      <h3>Repair requests</h3>
      <p id="requestsMeta">Loading requests...</p>
      <div id="requests" class="requests"></div>
    </div>
  </main>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    const emailEl = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const requestsEl = document.getElementById('requests');
    const requestsMeta = document.getElementById('requestsMeta');

    function formatDate(value) {
      if (!value) {
        return "Unknown time";
      }
      return new Date(value).toLocaleString();
    }

    function renderRequests(requests) {
      requestsEl.innerHTML = "";

      if (!requests.length) {
        requestsMeta.textContent = "No requests yet.";
        return;
      }

      requestsMeta.textContent = `${requests.length} request(s) total.`;

      requests.forEach((request) => {
        const card = document.createElement('div');
        card.className = 'request';

        const header = document.createElement('div');
        header.className = 'request-header';

        const title = document.createElement('strong');
        title.textContent = request.name || 'No name';

        const status = document.createElement('span');
        const statusValue = (request.status || 'Pending').toLowerCase();
        status.className = `status ${statusValue === 'completed' ? 'completed' : 'pending'}`;
        status.textContent = request.status || 'Pending';

        header.appendChild(title);
        header.appendChild(status);

        const meta = document.createElement('div');
        meta.className = 'request-meta';

        const addMetaLine = (label, value) => {
          const line = document.createElement('span');
          const strong = document.createElement('strong');
          strong.textContent = `${label}:`;
          line.appendChild(strong);
          line.append(` ${value || 'N/A'}`);
          meta.appendChild(line);
        };

        addMetaLine('Email', request.email);
        addMetaLine('Phone', request.phone);
        addMetaLine('Device', request.device);
        addMetaLine('Issue', request.issue);
        addMetaLine('Created', formatDate(request.created_at));

        const actions = document.createElement('div');
        actions.className = 'request-actions';

        const completeBtn = document.createElement('button');
        completeBtn.className = 'secondary';
        completeBtn.textContent = 'Mark completed';
        completeBtn.dataset.action = 'complete';
        completeBtn.dataset.id = request.id;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'danger';
        deleteBtn.textContent = 'Delete';
        deleteBtn.dataset.action = 'delete';
        deleteBtn.dataset.id = request.id;

        actions.appendChild(completeBtn);
        actions.appendChild(deleteBtn);

        card.appendChild(header);
        card.appendChild(meta);
        card.appendChild(actions);
        requestsEl.appendChild(card);
      });
    }

    async function getAuthToken() {
      const user = netlifyIdentity.currentUser();
      if (!user) {
        return null;
      }
      if (user.token && user.token.access_token) {
        return user.token.access_token;
      }
      if (typeof user.jwt === 'function') {
        return await user.jwt();
      }
      return null;
    }

    async function loadRequests() {
      requestsMeta.textContent = "Loading requests...";
      const token = await getAuthToken();
      if (!token) {
        requestsMeta.textContent = "Session expired. Please log in again.";
        return;
      }

      const response = await fetch('/.netlify/functions/requests', {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      if (!response.ok) {
        console.error(await response.text());
        requestsMeta.textContent = "Failed to load requests.";
        return;
      }

      const data = await response.json();
      renderRequests(Array.isArray(data) ? data : []);
    }

    async function updateStatus(id, status) {
      const token = await getAuthToken();
      if (!token) {
        alert("Session expired. Please log in again.");
        return;
      }

      const response = await fetch('/.netlify/functions/requests', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ id, status })
      });

      if (!response.ok) {
        alert("Failed to update status.");
        console.error(await response.text());
        return;
      }

      loadRequests();
    }

    async function deleteRequest(id) {
      const token = await getAuthToken();
      if (!token) {
        alert("Session expired. Please log in again.");
        return;
      }

      const response = await fetch('/.netlify/functions/requests', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ id })
      });

      if (!response.ok) {
        alert("Failed to delete request.");
        console.error(await response.text());
        return;
      }

      loadRequests();
    }

    if (window.netlifyIdentity) {
      netlifyIdentity.on('init', (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }
        emailEl.textContent = user.email;
        loadRequests();
      });

      netlifyIdentity.on('logout', () => {
        window.location.href = "login.html";
      });

      logoutBtn.addEventListener('click', () => {
        netlifyIdentity.logout();
      });

      netlifyIdentity.init();
    } else {
      window.location.href = "login.html";
    }

    requestsEl.addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) {
        return;
      }
      const id = button.dataset.id;
      if (!id) {
        return;
      }

      if (button.dataset.action === 'complete') {
        updateStatus(id, 'Completed');
      } else if (button.dataset.action === 'delete') {
        if (confirm('Delete this request?')) {
          deleteRequest(id);
        }
      }
    });
  </script>
</body>
</html>
